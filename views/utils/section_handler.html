<script type="text/javascript">
    function section_master_handler(parent, section_name){
        $.ajax({
            url: "{{=URL('api', 'sections')}}" + "/" + section_name,
            method: "GET",
            success: function(section_definition){
                build_card(
                    parent,
                    section_definition["section_name"],
                    true,
                    section_definition["allowed_operation"].includes("create")
                );
                build_title(section_definition["section_name"] + "_card_header", section_definition["section_title"]);

                build_modal("main_view_port", section_definition["section_name"]);
                let modal_footer = $("#" + section_definition["section_name"] + "_modal_footer");

                $("#" + section_definition["section_name"] + "_modal_title").html(
                    section_definition["section_title"]
                );

                if (section_definition["allowed_operation"].includes("create")){
                    build_button(
                        section_definition["section_name"] + "_card_footer",
                        section_definition["section_name"] + "_create",
                        "primary",
                        "Create",
                    );
                    
                    $("#" + section_definition["section_name"] + "_create").attr(
                        "data-toggle", "modal"
                    ).attr(
                        "data-target", "#" + section_definition["section_name"] + "_modal"
                    );

                    $("#" + section_definition["section_name"] + "_create").bind("click", function(){
                        if (
                            section_definition["allowed_operation"].includes("create")
                        ){
                            modal_footer.empty();
                            build_button(
                                section_definition["section_name"] + "_modal_footer",
                                section_definition["section_name"] + "_modal_create",
                                "primary",
                                "Create"
                            );
                        }
                    });
                }

                let header = [];
                for (let i=0; i<section_definition["summary_fields"].length; i++){
                    header.push(section_definition["summary_fields"][i]);
                }

                // TODO: spinning loading effect

                $.ajax({
                    url: "{{=URL('api', 'template')}}",
                    method: "GET",
                    data: {api_name: section_definition["api_name"]},
                    success: function(section_data){
                        build_table(section_definition["section_name"] + "_card_body", section_definition["section_name"] + "_table");
                        build_table_header(section_definition["section_name"] + "_table", header);

                        for (let i=0; i<section_data.length; i++){
                            let tr = $("<tr></tr>");
                            for (let j=0; j<header.length; j++){
                                tr.append(
                                    $("<td></td>").html(section_data[i][header[j]])
                                );
                            }
                            if (section_definition["allowed_operation"].includes("read")){
                                tr.attr(
                                    "data-toggle", "modal"
                                ).attr(
                                    "data-target", "#" + section_definition["section_name"] + "_modal"
                                ).bind("click", function(){
                                    if (
                                        section_definition["allowed_operation"].includes("update") ||
                                        section_definition["allowed_operation"].includes("delete")
                                    ){
                                        modal_footer.empty();
                                        if (section_definition["allowed_operation"].includes("update")){
                                            build_button(
                                                section_definition["section_name"] + "_modal_footer",
                                                section_definition["section_name"] + "_modal_edit",
                                                "primary",
                                                "Edit"
                                            );
                                        }
                                        if (section_definition["allowed_operation"].includes("delete")){
                                            build_button(
                                                section_definition["section_name"] + "_modal_footer",
                                                section_definition["section_name"] + "_modal_delete",
                                                "danger",
                                                "Delete"
                                            );
                                        }
                                    }
                                });
                            }

                            $("#" + section_definition["section_name"] + "_table_table_body").append(tr);
                        }

                        $("#" + section_definition["section_name"] + "_table").DataTable();
                    }
                });
            }
        });
    }
</script>
